{% extends 'dashboard_base.html' %}

{% block extra_css %}
<style>
    .order-card {
        transition: transform 0.2s;
        cursor: pointer;
    }
    .order-card:hover {
        transform: translateY(-5px);
    }
    .map-container {
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-truck"></i> Driver Dashboard</h2>
        </div>
        <div class="col-auto d-flex align-items-center gap-2">
            <a href="/" class="btn btn-outline-secondary btn-sm">Home</a>
            <a href="#" class="btn btn-outline-secondary btn-sm" onclick="window.logout(); return false;">Logout</a>
            <label for="statusSelect" class="form-label me-2 mb-0">Status:</label>
            <select class="form-select d-inline-block" id="statusSelect" onchange="updateStatus()" style="width: auto;">
                <option value="offline">Offline</option>
                <option value="available" selected>Available</option>
                <option value="busy">Busy</option>
            </select>
        </div>
    </div>
    
    <!-- Current Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> My Orders</h5>
                </div>
                <div class="card-body">
                    <div id="ordersList">
                        <p class="text-center text-muted">Loading orders...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Navigation</h5>
                </div>
                <div class="card-body">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                Loading...
            </div>
            <div class="modal-footer" id="orderActions">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY|default:'' }}&libraries=places,geometry&loading=async"></script>
<script>
    // API_BASE is already declared in base.html, use it directly
    var apiBase;
    if (typeof API_BASE !== 'undefined') {
        apiBase = API_BASE;
    } else {
        apiBase = '/api';
    }
    
    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        // Fallback: try to get from meta tag
        if (!cookieValue) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }
        return cookieValue;
    }
    
    let map, currentOrder = null, directionsService, directionsRenderer;
    let mapInitialized = false;
    
    function initMap() {
        // Check if Google Maps API is loaded
        if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.Map === 'undefined') {
            console.warn('Google Maps API not loaded yet');
            return false;
        }
        
        // Default to Nairobi center
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return false;
        }
        
        try {
            map = new google.maps.Map(mapElement, {
                center: { lat: -1.2921, lng: 36.8219 },
                zoom: 12
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
            mapInitialized = true;
            console.log('Map initialized successfully');
            return true;
        } catch (error) {
            console.error('Error initializing map:', error);
            return false;
        }
    }
    
    // Wait for Google Maps API to load
    function waitForGoogleMaps(maxAttempts = 50) {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.Map !== 'undefined') {
                    clearInterval(checkInterval);
                    console.log('Google Maps API is ready');
                    resolve();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('Google Maps API did not load in time');
                    reject(new Error('Google Maps API timeout'));
                }
            }, 100);
        });
    }
    
    async function loadOrders() {
        console.log('Loading driver orders...');
        console.log('API Base:', apiBase);
        const ordersList = document.getElementById('ordersList');
        if (!ordersList) {
            console.error('Orders list element not found');
            return;
        }
        
        ordersList.innerHTML = '<p class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading orders...</p>';
        
        try {
            const url = `${apiBase}/drivers/orders/`;
            console.log('Fetching orders from:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Orders response status:', response.status);
            console.log('Orders response headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.status === 401 || response.status === 403) {
                console.error('Unauthorized - redirecting to login');
                ordersList.innerHTML = '<p class="text-center text-warning">Please log in to view your orders. Redirecting...</p>';
                setTimeout(() => {
                    window.location.href = '/?login=1';
                }, 2000);
                return;
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API error ${response.status}:`, errorText);
                ordersList.innerHTML = `<p class="text-center text-danger">
                    Error loading orders (${response.status})<br>
                    <small>${errorText.substring(0, 100)}</small>
                </p>`;
                return;
            }
            
            const orders = await response.json();
            console.log('Loaded orders:', orders);
            console.log('Orders type:', typeof orders);
            console.log('Is array?', Array.isArray(orders));
            
            if (!Array.isArray(orders)) {
                console.error('Invalid response format:', orders);
                ordersList.innerHTML = '<p class="text-center text-danger">Invalid response format. Expected an array.</p>';
                return;
            }
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-center text-muted">No orders assigned yet. Orders will appear here once an admin assigns them to you.</p>';
                return;
            }
            
            ordersList.innerHTML = orders.map(order => {
                const statusBadge = getStatusBadge(order.status);
                return `
                    <div class="card order-card mb-3" onclick="viewOrder(${order.id})" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${order.tracking_code || 'N/A'}</h6>
                                ${statusBadge}
                            </div>
                            <p class="mb-1"><strong><i class="fas fa-map-marker-alt text-danger"></i> From:</strong> ${order.pickup_address || 'N/A'}</p>
                            <p class="mb-1"><strong><i class="fas fa-map-marker-alt text-success"></i> To:</strong> ${order.delivery_address || 'N/A'}</p>
                            <p class="mb-0 text-muted"><small>Price: KES ${order.price || '0'}</small></p>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading orders:', error);
            console.error('Error stack:', error.stack);
            ordersList.innerHTML = `<p class="text-center text-danger">
                Error loading orders: ${error.message}<br>
                <small>Check browser console for details</small>
            </p>`;
        }
    }
    
    function getStatusBadge(status) {
        const badges = {
            'assigned': '<span class="badge bg-warning">ASSIGNED</span>',
            'accepted': '<span class="badge bg-info">ACCEPTED</span>',
            'picked_up': '<span class="badge bg-primary">PICKED UP</span>',
            'in_transit': '<span class="badge bg-secondary">IN TRANSIT</span>',
            'delivered': '<span class="badge bg-success">DELIVERED</span>',
            'cancelled': '<span class="badge bg-danger">CANCELLED</span>'
        };
        const statusKey = (status || '').replace(/_/g, '_').toLowerCase();
        return badges[statusKey] || `<span class="badge bg-secondary">${(status || '').replace(/_/g, ' ').toUpperCase()}</span>`;
    }
    
    async function viewOrder(orderId) {
        try {
            console.log('Loading order details for:', orderId);
            const response = await fetch(`${apiBase}/orders/${orderId}/`, {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Error loading order: ${response.status}`, errorText);
                alert('Failed to load order details');
                return;
            }
            
            const order = await response.json();
            currentOrder = order;
            console.log('Order loaded:', order);
            
            // Show order details
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt text-danger"></i> Pickup Details</h6>
                        <p><strong>Name:</strong> ${order.pickup_name || 'N/A'}</p>
                        <p><strong>Phone:</strong> <a href="tel:${order.pickup_phone}">${order.pickup_phone || 'N/A'}</a></p>
                        <p><strong>Address:</strong> ${order.pickup_address || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt text-success"></i> Delivery Details</h6>
                        <p><strong>Name:</strong> ${order.delivery_name || 'N/A'}</p>
                        <p><strong>Phone:</strong> <a href="tel:${order.delivery_phone}">${order.delivery_phone || 'N/A'}</a></p>
                        <p><strong>Address:</strong> ${order.delivery_address || 'N/A'}</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Tracking Code:</strong> ${order.tracking_code || 'N/A'}</p>
                        <p><strong>Price:</strong> KES ${order.price || '0'}</p>
                        <p><strong>Status:</strong> ${getStatusBadge(order.status)}</p>
                    </div>
                    <div class="col-md-6">
                        ${order.parcel_description ? `<p><strong>Description:</strong> ${order.parcel_description}</p>` : ''}
                        ${order.special_instructions ? `<p><strong>Instructions:</strong> ${order.special_instructions}</p>` : ''}
                    </div>
                </div>
                <div id="feedbackSection" style="display: none;">
                    <hr>
                    <h6>Delivery Feedback</h6>
                    <textarea id="feedbackText" class="form-control" rows="3" placeholder="Enter delivery feedback (optional)"></textarea>
                </div>
            `;
            
            // Show actions based on status
            let actions = '';
            if (order.status === 'assigned') {
                actions = '<button class="btn btn-primary" onclick="acceptOrder()"><i class="fas fa-check"></i> Accept Order</button>';
            } else if (order.status === 'accepted') {
                actions = '<button class="btn btn-success" onclick="confirmPickup()"><i class="fas fa-box"></i> Confirm Pickup</button>';
            } else if (order.status === 'picked_up') {
                actions = '<button class="btn btn-info" onclick="startTransit()"><i class="fas fa-truck"></i> Start Transit</button>';
            } else if (order.status === 'in_transit') {
                actions = '<button class="btn btn-success" onclick="confirmDelivery()"><i class="fas fa-check-circle"></i> Confirm Delivery</button>';
            } else if (order.status === 'delivered') {
                actions = '<span class="text-success"><i class="fas fa-check-circle"></i> Order Delivered</span>';
                document.getElementById('feedbackSection').style.display = 'block';
            }
            document.getElementById('orderActions').innerHTML = actions;
            
            // Update map
            if (order.pickup_latitude && order.pickup_longitude && order.delivery_latitude && order.delivery_longitude) {
                updateMap(order);
            } else {
                console.warn('Order missing coordinates, cannot show map');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        } catch (error) {
            console.error('Error loading order:', error);
            alert('An error occurred while loading order details');
        }
    }
    
    function updateMap(order) {
        if (!mapInitialized || !map) {
            console.warn('Map not initialized, attempting to initialize...');
            if (initMap()) {
                // Retry after initialization
                setTimeout(() => updateMap(order), 100);
            } else {
                console.error('Map initialization failed');
                return;
            }
            return;
        }
        
        const pickup = { 
            lat: parseFloat(order.pickup_latitude), 
            lng: parseFloat(order.pickup_longitude) 
        };
        const delivery = { 
            lat: parseFloat(order.delivery_latitude), 
            lng: parseFloat(order.delivery_longitude) 
        };
        
        // Center map between pickup and delivery
        const centerLat = (pickup.lat + delivery.lat) / 2;
        const centerLng = (pickup.lng + delivery.lng) / 2;
        map.setCenter({ lat: centerLat, lng: centerLng });
        map.setZoom(13);
        
        // Add markers
        const pickupMarker = new google.maps.Marker({
            position: pickup,
            map: map,
            label: 'P',
            title: 'Pickup Location',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            }
        });
        
        const deliveryMarker = new google.maps.Marker({
            position: delivery,
            map: map,
            label: 'D',
            title: 'Delivery Location',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
            }
        });
        
        // Add route
        if (directionsService && directionsRenderer) {
            directionsService.route({
                origin: pickup,
                destination: delivery,
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                } else {
                    console.error('Directions request failed:', status);
                }
            });
        }
    }
    
    async function acceptOrder() {
        if (!currentOrder) return;
        
        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/drivers/orders/${currentOrder.id}/accept/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include'
            });
            
            const result = await response.json();
            if (response.ok) {
                alert('Order accepted!');
                bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
                loadOrders();
            } else {
                alert(result.error || 'Failed to accept order');
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }
    
    async function confirmPickup() {
        if (!currentOrder) return;
        
        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/orders/${currentOrder.id}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    status: 'picked_up', 
                    description: 'Parcel picked up by driver' 
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                alert('Pickup confirmed! You can now start transit.');
                bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
                loadOrders();
            } else {
                alert(result.error || 'Failed to confirm pickup');
            }
        } catch (error) {
            console.error('Error confirming pickup:', error);
            alert('An error occurred. Please try again.');
        }
    }
    
    async function startTransit() {
        if (!currentOrder) return;
        
        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/orders/${currentOrder.id}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    status: 'in_transit', 
                    description: 'Order is in transit to delivery location' 
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                alert('Transit started! You can now proceed to delivery location.');
                bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
                loadOrders();
            } else {
                alert(result.error || 'Failed to start transit');
            }
        } catch (error) {
            console.error('Error starting transit:', error);
            alert('An error occurred. Please try again.');
        }
    }
    
    async function confirmDelivery() {
        if (!currentOrder) return;
        
        const feedbackText = document.getElementById('feedbackText')?.value || '';
        
        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/orders/${currentOrder.id}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    status: 'delivered', 
                    description: feedbackText || 'Parcel delivered successfully',
                    feedback: feedbackText
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                alert('Delivery confirmed! Thank you for your service.');
                bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
                loadOrders();
                
                // Update driver status back to available if no other orders
                setTimeout(async () => {
                    await updateDriverStatusToAvailable();
                }, 1000);
            } else {
                alert(result.error || 'Failed to confirm delivery');
            }
        } catch (error) {
            console.error('Error confirming delivery:', error);
            alert('An error occurred. Please try again.');
        }
    }
    
    async function updateDriverStatusToAvailable() {
        try {
            const driverId = await getDriverId();
            if (!driverId) return;
            
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/drivers/${driverId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify({ status: 'available' })
            });
            
            if (response.ok) {
                document.getElementById('statusSelect').value = 'available';
                console.log('Driver status updated to available');
            }
        } catch (error) {
            console.error('Error updating driver status:', error);
        }
    }
    
    async function updateStatus() {
        const statusSelect = document.getElementById('statusSelect');
        if (!statusSelect) {
            console.error('Status select element not found');
            return;
        }
        
        const status = statusSelect.value;
        console.log('Updating driver status to:', status);
        
        try {
            const driverId = await getDriverId();
            if (!driverId) {
                console.error('Unable to get driver ID');
                alert('Unable to get driver ID. Please refresh the page.');
                return;
            }
            
            console.log('Updating status for driver ID:', driverId);
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`${apiBase}/drivers/${driverId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify({ status: status })
            });
            
            console.log('Update status response:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Status update failed:', response.status, errorText);
                let errorMessage = 'Failed to update status';
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    errorMessage = `Server error: ${response.status}`;
                }
                alert(errorMessage);
                return;
            }
            
            const result = await response.json();
            console.log('Status update result:', result);
            alert('Status updated successfully!');
        } catch (error) {
            console.error('Error updating status:', error);
            alert('An error occurred while updating status: ' + error.message);
        }
    }
    
    let cachedDriverId = null;
    
    async function getDriverId() {
        if (cachedDriverId) {
            return cachedDriverId;
        }
        
        try {
            const response = await fetch(`${apiBase}/auth/me/`, { 
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                console.error('Failed to get user data:', response.status);
                return null;
            }
            
            const data = await response.json();
            console.log('User data:', data);
            
            // Try different ways to get driver ID
            const driverId = data.profile?.id || 
                           (data.profile && data.profile.id) ||
                           (data.user && data.user.driver_profile && data.user.driver_profile.id);
            
            if (driverId) {
                cachedDriverId = driverId;
                console.log('Driver ID cached:', driverId);
                return driverId;
            }
            
            console.error('Driver ID not found in response:', data);
            return null;
        } catch (error) {
            console.error('Error getting driver ID:', error);
            return null;
        }
    }
    
    async function loadDriverStatus() {
        try {
            const driverId = await getDriverId();
            if (!driverId) {
                console.warn('Driver ID not found, defaulting to available');
                const statusSelect = document.getElementById('statusSelect');
                if (statusSelect) {
                    statusSelect.value = 'available';
                }
                return;
            }
            
            console.log('Loading driver status for ID:', driverId);
            const response = await fetch(`${apiBase}/drivers/${driverId}/status/`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            console.log('Status response:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Status data:', data);
                const status = data.driver?.status || 'available';
                const statusSelect = document.getElementById('statusSelect');
                if (statusSelect) {
                    statusSelect.value = status;
                    console.log('Driver status set to:', status);
                }
            } else {
                const errorText = await response.text();
                console.error('Failed to load driver status:', response.status, errorText);
                // Default to available
                const statusSelect = document.getElementById('statusSelect');
                if (statusSelect) {
                    statusSelect.value = 'available';
                }
            }
        } catch (error) {
            console.error('Error loading driver status:', error);
            // Default to available
            const statusSelect = document.getElementById('statusSelect');
            if (statusSelect) {
                statusSelect.value = 'available';
            }
        }
    }
    
    // Initialize
    console.log('Driver dashboard script loaded');
    
    // Initialize everything when page loads
    async function initializeDashboard() {
        console.log('Initializing driver dashboard...');
        
        // Load driver status and orders immediately (don't wait for map)
        loadDriverStatus();
        loadOrders();
        
        // Wait for Google Maps API to load, then initialize map
        try {
            await waitForGoogleMaps();
            // Small delay to ensure everything is ready
            setTimeout(() => {
                if (initMap()) {
                    console.log('Map initialization complete');
                } else {
                    console.warn('Map initialization failed, but continuing...');
                    const mapElement = document.getElementById('map');
                    if (mapElement) {
                        mapElement.innerHTML = '<p class="text-center text-muted p-3">Map unavailable. Please ensure Google Maps API key is configured.</p>';
                    }
                }
            }, 200);
        } catch (error) {
            console.error('Failed to load Google Maps API:', error);
            // Continue without map - orders can still be loaded
            const mapElement = document.getElementById('map');
            if (mapElement) {
                mapElement.innerHTML = '<p class="text-center text-muted p-3">Map unavailable. Please ensure Google Maps API key is configured.</p>';
            }
        }
    }
    
    // Load orders and driver status when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing driver dashboard...');
            initializeDashboard();
        });
    } else {
        console.log('DOM already loaded, initializing driver dashboard...');
        initializeDashboard();
    }
</script>
{% endblock %}

