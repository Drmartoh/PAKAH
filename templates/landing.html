{% extends 'base.html' %}

{% block extra_css %}
<style>
    :root {
        --primary-orange: #FCA311;
        --primary-blue: #4A90E2;
        --primary-black: #000000;
        --primary-green: #28a745;
        --primary-white: #FFFFFF;
        --light-blue: #E8F4F8;
        --dark-blue: #2C5F8D;
        --blueish: #6BA3D8;
    }
    
    .hero-section {
        background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-blue) 100%);
        min-height: 90vh;
        display: flex;
        align-items: center;
        position: relative;
        overflow: hidden;
    }
    
    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }
    
    .hero-content {
        position: relative;
        z-index: 2;
    }
    
    .hero-title {
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1.2;
        margin-bottom: 1.5rem;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .hero-subtitle {
        font-size: 1.3rem;
        color: rgba(255,255,255,0.95);
        margin-bottom: 2rem;
        font-weight: 300;
    }
    
    .cta-button {
        background: var(--primary-black);
        color: white;
        padding: 1rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        margin-right: 1rem;
        margin-bottom: 1rem;
        text-decoration: none;
        display: inline-block;
    }
    
    .cta-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        background: #1a1a1a;
        color: white;
    }
    
    .book-now-button {
        background: var(--primary-green);
        color: white;
        padding: 1rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
    }
    
    .book-now-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        background: #218838;
        color: white;
    }
    
    .floating-icon {
        position: absolute;
        opacity: 0.1;
        animation: float 6s ease-in-out infinite;
    }
    
    .floating-icon:nth-child(1) {
        top: 10%;
        right: 10%;
        animation-delay: 0s;
    }
    
    .floating-icon:nth-child(2) {
        bottom: 20%;
        left: 5%;
        animation-delay: 2s;
    }
    
    .floating-icon:nth-child(3) {
        top: 50%;
        right: 5%;
        animation-delay: 4s;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }
    
    .pricing-section {
        padding: 80px 0;
        background: var(--light-blue);
    }
    
    .pricing-card {
        background: white;
        border-radius: 20px;
        padding: 3rem 2rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .pricing-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.12);
        border-color: var(--primary-orange);
    }
    
    .pricing-amount {
        font-size: 3rem;
        font-weight: 800;
        color: var(--primary-orange);
        margin: 1rem 0;
    }
    
    .pricing-label {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 1.5rem;
    }
    
    .simple-steps {
        padding: 80px 0;
        background: white;
    }
    
    .step-number {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-blue) 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto 1.5rem;
    }
    
    .step-card {
        text-align: center;
        padding: 2rem;
    }
    
    .step-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--primary-black);
    }
    
    .step-description {
        color: #666;
        font-size: 1rem;
    }
    
    .contact-section {
        padding: 80px 0;
        background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blueish) 100%);
        color: white;
    }
    
    .contact-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .contact-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-5px);
    }
    
    .contact-icon {
        font-size: 2.5rem;
        color: var(--primary-orange);
        margin-bottom: 1rem;
    }
    
    .contact-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .contact-info {
        font-size: 1rem;
        opacity: 0.9;
        line-height: 1.6;
    }
    
    #officeMap {
        height: 200px;
        width: 100%;
        border-radius: 10px;
        margin-top: 1rem;
        background: rgba(255,255,255,0.1);
    }
    
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.5rem;
        }
        .hero-subtitle {
            font-size: 1.1rem;
        }
        .cta-button, .book-now-button {
            display: block;
            width: 100%;
            margin-right: 0;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="floating-icon">
        <i class="fas fa-box" style="font-size: 150px;"></i>
    </div>
    <div class="floating-icon">
        <i class="fas fa-truck" style="font-size: 120px;"></i>
    </div>
    <div class="floating-icon">
        <i class="fas fa-shipping-fast" style="font-size: 100px;"></i>
    </div>
    
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-7 hero-content">
                <h1 class="hero-title">Fast Parcel Delivery<br>Across Kenya</h1>
                <p class="hero-subtitle">Get your packages delivered quickly and safely. Track in real-time, pay with M-Pesa.</p>
                <div>
                    {% if not user.is_authenticated %}
                    <a href="#" class="cta-button" data-bs-toggle="modal" data-bs-target="#signupModal">
                        Get Started <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                    <button class="book-now-button" onclick="handleBookNow()">
                        <i class="fas fa-calendar-check"></i> Book Now
                    </button>
                    {% else %}
                    <a href="/dashboard/" class="cta-button">
                        Go to Dashboard <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                    <button class="book-now-button" onclick="openOrderForm()">
                        <i class="fas fa-calendar-check"></i> Book Now
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Simple Steps -->
<section class="simple-steps">
    <div class="container">
        <h2 class="text-center mb-5" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-black);">How It Works</h2>
        <div class="row">
            <div class="col-md-4 step-card">
                <div class="step-number">1</div>
                <h3 class="step-title">Place Order</h3>
                <p class="step-description">Enter pickup and delivery locations. We calculate the price instantly.</p>
            </div>
            <div class="col-md-4 step-card">
                <div class="step-number">2</div>
                <h3 class="step-title">Pay Securely</h3>
                <p class="step-description">Pay via M-Pesa with one tap. Fast and secure payment processing.</p>
            </div>
            <div class="col-md-4 step-card">
                <div class="step-number">3</div>
                <h3 class="step-title">Track & Receive</h3>
                <p class="step-description">Watch your parcel in real-time. Get notified when it arrives.</p>
            </div>
        </div>
    </div>
</section>

<!-- Pricing -->
<section class="pricing-section">
    <div class="container">
        <h2 class="text-center mb-5" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-black);">Simple Pricing</h2>
        <div class="row justify-content-center">
            <div class="col-md-5 mb-4">
                <div class="pricing-card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-black);">Within Nairobi</h3>
                    <div class="pricing-amount">KES 150</div>
                    <p class="pricing-label">Fixed rate for all deliveries</p>
                </div>
            </div>
            <div class="col-md-5 mb-4">
                <div class="pricing-card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary-black);">Nationwide</h3>
                    <div class="pricing-amount">KES 300</div>
                    <p class="pricing-label">Fixed rate for all deliveries</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contact Information -->
<section class="contact-section">
    <div class="container">
        <h2 class="text-center mb-5" style="font-size: 2.5rem; font-weight: 700;">Contact Us</h2>
        <div class="row">
            <div class="col-md-4">
                <div class="contact-card text-center">
                    <div class="contact-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="contact-title">Call Us</div>
                    <div class="contact-info">0792-044-622</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="contact-card text-center">
                    <div class="contact-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="contact-title">M-Pesa Till</div>
                    <div class="contact-info">5630946</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="contact-card text-center">
                    <div class="contact-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="contact-title">Location</div>
                    <div class="contact-info">Nairobi CBD, Mfangano Street<br>Ndaragwa Hse, Mezanine MF22</div>
                    <div id="officeMap"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Order Form Modal (for authenticated users) -->
{% if user.is_authenticated %}
<div class="modal fade" id="orderFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-blue) 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-box"></i> Book Your Delivery</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <form id="quickOrderForm">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 style="color: var(--primary-orange); font-weight: 700; margin-bottom: 1.5rem;">
                                <i class="fas fa-map-marker-alt"></i> Pickup Details
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Name</label>
                            <input type="text" class="form-control" name="pickup_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Phone</label>
                            <input type="tel" class="form-control" name="pickup_phone" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Pickup Address <small class="text-muted">(Start typing to see suggestions)</small></label>
                            <input type="text" class="form-control" id="pickupAddressQuick" name="pickup_address" required autocomplete="off">
                            <input type="hidden" id="pickupLatQuick" name="pickup_latitude">
                            <input type="hidden" id="pickupLngQuick" name="pickup_longitude">
                        </div>
                    </div>
                    
                    <hr style="margin: 2rem 0;">
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 style="color: var(--primary-blue); font-weight: 700; margin-bottom: 1.5rem;">
                                <i class="fas fa-truck"></i> Delivery Details
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Delivery Name</label>
                            <input type="text" class="form-control" name="delivery_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Delivery Phone</label>
                            <input type="tel" class="form-control" name="delivery_phone" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Delivery Address <small class="text-muted">(Start typing to see suggestions)</small></label>
                            <input type="text" class="form-control" id="deliveryAddressQuick" name="delivery_address" required autocomplete="off">
                            <input type="hidden" id="deliveryLatQuick" name="delivery_latitude">
                            <input type="hidden" id="deliveryLngQuick" name="delivery_longitude">
                        </div>
                    </div>
                    
                    <div class="price-display" style="background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-blue) 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center; margin: 1.5rem 0;">
                        <h5 style="margin: 0; font-size: 1.2rem; font-weight: 600;">Estimated Price</h5>
                        <div class="amount" id="estimatedPriceQuick" style="font-size: 2rem; font-weight: 800; margin-top: 0.5rem;">KES 0</div>
                    </div>
                    
                    <button type="submit" class="btn w-100" style="background: var(--primary-black); color: white; padding: 1rem; border-radius: 10px; font-weight: 600; font-size: 1.1rem;">
                        <i class="fas fa-check"></i> Create Order
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    const GOOGLE_MAPS_API_KEY = '{{ GOOGLE_MAPS_API_KEY|default:"" }}';
    let pickupAutocompleteQuick, deliveryAutocompleteQuick;
    let officeMap;
    let mapsLoaded = false;
    
    // Request location permission
    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('Location permission granted');
                },
                function(error) {
                    console.warn('Location permission denied:', error);
                }
            );
        }
    }
    
    // Request location on page load
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function() { console.log('Location access granted'); },
            function() { console.log('Location access denied or unavailable'); }
        );
    }
    
    // Load Google Maps with callback
    function loadGoogleMaps() {
        if (mapsLoaded || typeof google !== 'undefined') {
            initMaps();
            return;
        }
        
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&loading=async&callback=initMaps`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps');
        };
        document.head.appendChild(script);
    }
    
    // Initialize maps when Google Maps loads
    window.initMaps = function() {
        mapsLoaded = true;
        console.log('Google Maps loaded successfully');
        initOfficeMap();
        initQuickOrderAutocomplete();
    };
    
    // Initialize Office Location Map
    function initOfficeMap() {
        if (!mapsLoaded || typeof google === 'undefined' || !google.maps) {
            return;
        }
        
        const officeMapElement = document.getElementById('officeMap');
        if (!officeMapElement) return;
        
        const officeLocation = {
            lat: {{ OFFICE_LATITUDE|default:-1.2921 }},
            lng: {{ OFFICE_LONGITUDE|default:36.8219 }}
        };
        
        officeMap = new google.maps.Map(officeMapElement, {
            center: officeLocation,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false
        });
        
        const marker = new google.maps.Marker({
            position: officeLocation,
            map: officeMap,
            title: 'PAKA HOME Office',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png'
            }
        });
        
        const infoWindow = new google.maps.InfoWindow({
            content: '<div style="padding: 10px;"><strong>PAKA HOME</strong><br>{{ OFFICE_ADDRESS|default:"Nairobi CBD, Mfangano Street, Ndaragwa Hse, Mezanine MF22" }}</div>'
        });
        
        marker.addListener('click', function() {
            infoWindow.open(officeMap, marker);
        });
        
        infoWindow.open(officeMap, marker);
    }
    
    // Initialize Google Maps Autocomplete for quick order form
    function initQuickOrderAutocomplete() {
        if (!mapsLoaded || typeof google === 'undefined' || !google.maps || !google.maps.places) {
            console.log('Maps not ready, retrying...');
            setTimeout(initQuickOrderAutocomplete, 100);
            return;
        }
        
        {% if user.is_authenticated %}
        const pickupInput = document.getElementById('pickupAddressQuick');
        const deliveryInput = document.getElementById('deliveryAddressQuick');
        
        if (!pickupInput || !deliveryInput) {
            console.log('Input fields not found, waiting...');
            return;
        }
        
        // Check if inputs are visible (modal is open)
        if (pickupInput.offsetParent === null || deliveryInput.offsetParent === null) {
            console.log('Input fields not visible (modal closed), will initialize when modal opens');
            return;
        }
        
        // Clear existing listeners
        if (pickupAutocompleteQuick) {
            google.maps.event.clearInstanceListeners(pickupInput);
            pickupAutocompleteQuick = null;
        }
        if (deliveryAutocompleteQuick) {
            google.maps.event.clearInstanceListeners(deliveryInput);
            deliveryAutocompleteQuick = null;
        }
        
        try {
            console.log('Initializing autocomplete for pickup and delivery fields...');
            
            pickupAutocompleteQuick = new google.maps.places.Autocomplete(pickupInput, {
                componentRestrictions: { country: 'ke' },
                fields: ['geometry', 'formatted_address', 'name', 'place_id'],
                types: ['address']
            });
            
            deliveryAutocompleteQuick = new google.maps.places.Autocomplete(deliveryInput, {
                componentRestrictions: { country: 'ke' },
                fields: ['geometry', 'formatted_address', 'name', 'place_id'],
                types: ['address']
            });
            
            pickupAutocompleteQuick.addListener('place_changed', function() {
                const place = pickupAutocompleteQuick.getPlace();
                console.log('Pickup place selected:', place);
                if (place.geometry) {
                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    document.getElementById('pickupLatQuick').value = lat;
                    document.getElementById('pickupLngQuick').value = lng;
                    console.log('Pickup coordinates:', lat, lng);
                    calculateQuickPrice();
                } else {
                    console.warn('No geometry found for pickup place');
                }
            });
            
            deliveryAutocompleteQuick.addListener('place_changed', function() {
                const place = deliveryAutocompleteQuick.getPlace();
                console.log('Delivery place selected:', place);
                if (place.geometry) {
                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    document.getElementById('deliveryLatQuick').value = lat;
                    document.getElementById('deliveryLngQuick').value = lng;
                    console.log('Delivery coordinates:', lat, lng);
                    calculateQuickPrice();
                } else {
                    console.warn('No geometry found for delivery place');
                }
            });
            
            console.log('Quick order autocomplete initialized successfully');
        } catch (error) {
            console.error('Error initializing autocomplete:', error);
            alert('Failed to initialize address autocomplete. Please refresh the page.');
        }
        {% endif %}
    }
    
    function calculateQuickPrice() {
        const pickupLat = parseFloat(document.getElementById('pickupLatQuick')?.value);
        const pickupLng = parseFloat(document.getElementById('pickupLngQuick')?.value);
        const deliveryLat = parseFloat(document.getElementById('deliveryLatQuick')?.value);
        const deliveryLng = parseFloat(document.getElementById('deliveryLngQuick')?.value);
        
        if (isNaN(pickupLat) || isNaN(pickupLng) || isNaN(deliveryLat) || isNaN(deliveryLng)) {
            const priceElement = document.getElementById('estimatedPriceQuick');
            if (priceElement) {
                priceElement.textContent = 'KES 0';
            }
            return;
        }
        
        const nairobiBounds = {
            minLat: -1.5, maxLat: -1.1,
            minLng: 36.6, maxLng: 37.0
        };
        
        const pickupInNairobi = (
            pickupLat >= nairobiBounds.minLat && 
            pickupLat <= nairobiBounds.maxLat &&
            pickupLng >= nairobiBounds.minLng && 
            pickupLng <= nairobiBounds.maxLng
        );
        
        const deliveryInNairobi = (
            deliveryLat >= nairobiBounds.minLat && 
            deliveryLat <= nairobiBounds.maxLat &&
            deliveryLng >= nairobiBounds.minLng && 
            deliveryLng <= nairobiBounds.maxLng
        );
        
        const price = (pickupInNairobi && deliveryInNairobi) ? 150 : 300;
        const priceElement = document.getElementById('estimatedPriceQuick');
        if (priceElement) {
            priceElement.textContent = `KES ${price}`;
        }
    }
    
    function handleBookNow() {
        {% if user.is_authenticated %}
        openOrderForm();
        {% else %}
        alert('Please sign in or create an account to book a delivery.');
        const signupModal = new bootstrap.Modal(document.getElementById('signupModal'));
        signupModal.show();
        {% endif %}
    }
    
    function openOrderForm() {
        {% if user.is_authenticated %}
        const orderModal = new bootstrap.Modal(document.getElementById('orderFormModal'));
        orderModal.show();
        console.log('Opening order form modal...');
        // Wait for modal animation and input fields to be visible
        setTimeout(function() {
            if (mapsLoaded) {
                initQuickOrderAutocomplete();
            } else {
                const checkMaps = setInterval(function() {
                    if (mapsLoaded) {
                        clearInterval(checkMaps);
                        initQuickOrderAutocomplete();
                    }
                }, 100);
                // Timeout after 5 seconds
                setTimeout(function() {
                    clearInterval(checkMaps);
                }, 5000);
            }
        }, 500);
        {% else %}
        alert('Please sign in to book a delivery.');
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
        {% endif %}
    }
    
    // Handle quick order form submission
    {% if user.is_authenticated %}
    document.addEventListener('DOMContentLoaded', function() {
        const quickOrderForm = document.getElementById('quickOrderForm');
        if (quickOrderForm) {
            quickOrderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Convert coordinates to numbers
                if (data.pickup_latitude) data.pickup_latitude = parseFloat(data.pickup_latitude);
                if (data.pickup_longitude) data.pickup_longitude = parseFloat(data.pickup_longitude);
                if (data.delivery_latitude) data.delivery_latitude = parseFloat(data.delivery_latitude);
                if (data.delivery_longitude) data.delivery_longitude = parseFloat(data.delivery_longitude);
                
                // Validate coordinates
                if (!data.pickup_latitude || !data.pickup_longitude) {
                    alert('Please select a valid pickup address from the suggestions.');
                    return;
                }
                
                if (!data.delivery_latitude || !data.delivery_longitude) {
                    alert('Please select a valid delivery address from the suggestions.');
                    return;
                }
                
                try {
                    // Get CSRF token (function is in base.html)
                    const csrftoken = getCookie('csrftoken');
                    
                    const response = await fetch('/api/orders/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken || ''
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        alert('Order created successfully! Redirecting to dashboard...');
                        bootstrap.Modal.getInstance(document.getElementById('orderFormModal')).hide();
                        window.location.href = '/dashboard/';
                    } else {
                        const errorMsg = result.error || result.detail || Object.values(result).flat().join(', ') || 'Failed to create order';
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('Error creating order:', error);
                    alert('An error occurred. Please try again.');
                }
            });
        }
        
        // Initialize autocomplete when modal opens
        const orderModal = document.getElementById('orderFormModal');
        if (orderModal) {
            orderModal.addEventListener('shown.bs.modal', function() {
                console.log('Order modal opened, initializing autocomplete...');
                // Wait for modal animation and input fields to be visible
                setTimeout(function() {
                    if (mapsLoaded) {
                        initQuickOrderAutocomplete();
                    } else {
                        // Wait for maps to load
                        const checkMaps = setInterval(function() {
                            if (mapsLoaded) {
                                clearInterval(checkMaps);
                                initQuickOrderAutocomplete();
                            }
                        }, 100);
                        // Timeout after 5 seconds
                        setTimeout(function() {
                            clearInterval(checkMaps);
                        }, 5000);
                    }
                }, 500);
            });
        }
    });
    {% endif %}
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadGoogleMaps();
        requestLocationPermission();
    });
</script>
{% endblock %}
