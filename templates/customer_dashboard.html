{% extends 'dashboard_base.html' %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #FCA311 0%, #e6940f 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
    }
    
    .dashboard-title {
        color: white;
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }
    
    .new-order-btn {
        background: #000;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 50px;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .new-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        background: #1a1a1a;
        color: white;
    }
    
    .order-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid #FCA311;
    }
    
    .order-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }
    
    .status-badge {
        padding: 0.5rem 1.2rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-pending_payment { background-color: #ffc107; color: #000; }
    .status-pending_assignment { background-color: #17a2b8; color: #fff; }
    .status-assigned { background-color: #6c757d; color: #fff; }
    .status-accepted { background-color: #007bff; color: #fff; }
    .status-picked_up { background-color: #28a745; color: #fff; }
    .status-in_transit { background-color: #20c997; color: #fff; }
    .status-delivered { background-color: #28a745; color: #fff; }
    
    .tracking-code {
        font-size: 1.2rem;
        font-weight: 700;
        color: #FCA311;
        text-decoration: none;
    }
    
    .tracking-code:hover {
        color: #e6940f;
        text-decoration: underline;
    }
    
    .order-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #000;
    }
    
    .action-btn {
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
    }
    
    .action-btn-primary {
        background: #FCA311;
        color: #000;
    }
    
    .action-btn-primary:hover {
        background: #e6940f;
        transform: translateY(-2px);
    }
    
    .action-btn-outline {
        background: transparent;
        border: 2px solid #FCA311;
        color: #FCA311;
    }
    
    .action-btn-outline:hover {
        background: #FCA311;
        color: #000;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .modal-content {
        border-radius: 20px;
        border: none;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #FCA311 0%, #e6940f 100%);
        color: white;
        border-radius: 20px 20px 0 0;
        border: none;
    }
    
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e0e0e0;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #FCA311;
        box-shadow: 0 0 0 0.2rem rgba(252, 163, 17, 0.25);
    }
    
    .price-display {
        background: linear-gradient(135deg, #FCA311 0%, #e6940f 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        margin: 1.5rem 0;
    }
    
    .price-display h5 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .price-display .amount {
        font-size: 2rem;
        font-weight: 800;
        margin-top: 0.5rem;
    }
    
    .location-permission-alert {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="dashboard-title"><i class="fas fa-tachometer-alt"></i> My Dashboard</h1>
            </div>
            <div class="col-auto d-flex align-items-center gap-2">
                <a href="/" class="btn btn-sm text-white" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);">Home</a>
                <a href="#" class="btn btn-sm text-white" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);" onclick="window.logout(); return false;">Logout</a>
                <button class="new-order-btn" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                    <i class="fas fa-plus"></i> New Order
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Location Permission Alert -->
    <div id="locationPermissionAlert" class="location-permission-alert" style="display: none;">
        <strong><i class="fas fa-info-circle"></i> Location Access Required:</strong>
        Please enable location access in your browser to use address autocomplete features.
        <button class="btn btn-sm btn-warning ms-2" onclick="requestLocationPermission()">Enable Location</button>
    </div>

    <!-- Orders List -->
    <div class="row">
        <div class="col-12">
            <div class="card" style="border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 20px;">
                <div class="card-body" style="padding: 2rem;">
                    <h3 class="mb-4" style="font-weight: 700; color: #000;"><i class="fas fa-list"></i> My Orders</h3>
                    <div id="ordersList">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <p>Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog"></i> Account Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6><i class="fas fa-user"></i> Account Information</h6>
                    <p class="text-muted">Manage your account settings and preferences.</p>
                </div>
                
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Danger Zone</h6>
                    <p class="mb-2">Permanently delete your account and all associated data.</p>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                        <i class="fas fa-trash"></i> Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This action cannot be undone. This will permanently delete your account and all associated data including:
                    <ul class="mb-0 mt-2">
                        <li>Your profile information</li>
                        <li>All your orders</li>
                        <li>Payment history</li>
                        <li>All other account data</li>
                    </ul>
                </div>
                <form id="deleteAccountForm">
                    <div class="mb-3">
                        <label class="form-label">Enter your 4-Digit PIN to confirm:</label>
                        <input type="password" class="form-control" id="deletePin" name="pin" maxlength="4" pattern="[0-9]{4}" placeholder="1234" required>
                        <small class="text-muted">This is required to verify account deletion</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand that this action is permanent and cannot be undone
                        </label>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Permanently Delete Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-box"></i> Place New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <form id="newOrderForm">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 style="color: #FCA311; font-weight: 700; margin-bottom: 1.5rem;">
                                <i class="fas fa-map-marker-alt"></i> Pickup Details
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Name</label>
                            <input type="text" class="form-control" name="pickup_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Phone</label>
                            <input type="tel" class="form-control" name="pickup_phone" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Pickup Address <small class="text-muted">(Start typing to see suggestions)</small></label>
                            <input type="text" class="form-control" id="pickupAddress" name="pickup_address" required autocomplete="off" placeholder="Start typing to see suggestions...">
                            <input type="hidden" id="pickupLat" name="pickup_latitude">
                            <input type="hidden" id="pickupLng" name="pickup_longitude">
                            <small class="text-muted">Select an address from the dropdown for accurate location</small>
                        </div>
                        <div class="col-12 mb-3">
                            <div id="pickupMap" style="height: 200px; width: 100%; border-radius: 10px; margin-top: 0.5rem; display: none;"></div>
                        </div>
                    </div>
                    
                    <hr style="margin: 2rem 0;">
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 style="color: #FCA311; font-weight: 700; margin-bottom: 1.5rem;">
                                <i class="fas fa-truck"></i> Drop-off Details
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Drop-off Name</label>
                            <input type="text" class="form-control" name="delivery_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Drop-off Phone</label>
                            <input type="tel" class="form-control" name="delivery_phone" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Drop-off Address <small class="text-muted">(Start typing to see suggestions)</small></label>
                            <input type="text" class="form-control" id="deliveryAddress" name="delivery_address" required autocomplete="off" placeholder="Start typing to see suggestions...">
                            <input type="hidden" id="deliveryLat" name="delivery_latitude">
                            <input type="hidden" id="deliveryLng" name="delivery_longitude">
                            <small class="text-muted">Select an address from the dropdown for accurate location</small>
                        </div>
                        <div class="col-12 mb-3">
                            <div id="deliveryMap" style="height: 200px; width: 100%; border-radius: 10px; margin-top: 0.5rem; display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="price-display">
                        <h5>Estimated Price</h5>
                        <div class="amount" id="estimatedPrice">KES 0</div>
                    </div>
                    
                    <button type="submit" class="btn w-100" style="background: #000; color: white; padding: 1rem; border-radius: 10px; font-weight: 600; font-size: 1.1rem;">
                        <i class="fas fa-check"></i> Create Order
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const GOOGLE_MAPS_API_KEY = '{{ GOOGLE_MAPS_API_KEY|default:"" }}';
    // API_BASE is already declared in base.html, don't redeclare
    let pickupAutocomplete, deliveryAutocomplete;
    let mapsLoaded = false;
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        // Fallback: try to get from meta tag
        if (!cookieValue) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }
        return cookieValue;
    }
    
    // Request location permission
    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('Location permission granted');
                    document.getElementById('locationPermissionAlert').style.display = 'none';
                },
                function(error) {
                    console.warn('Location permission denied:', error);
                    alert('Location access is recommended for better address suggestions. You can still use the form manually.');
                }
            );
        }
    }
    
    // Check location permission on load
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function() { /* Permission granted */ },
            function() {
                document.getElementById('locationPermissionAlert').style.display = 'block';
            }
        );
    }
    
    let pickupMap, deliveryMap;
    let pickupMarker, deliveryMarker;
    
    // Load Google Maps with Places library
    function loadGoogleMaps() {
        if (mapsLoaded) return;
        
        // Load Google Maps with Places library
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&loading=async&callback=initMaps`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps');
            alert('Failed to load Google Maps. Please check your internet connection.');
        };
        document.head.appendChild(script);
    }
    
    // Initialize maps when Google Maps loads
    window.initMaps = function() {
        mapsLoaded = true;
        console.log('Google Maps loaded successfully');
        initAutocomplete();
    };
    
    // Initialize Google Maps Autocomplete using Places API directly
    function initAutocomplete() {
        console.log('initAutocomplete called. mapsLoaded:', mapsLoaded, 'google defined:', typeof google !== 'undefined');
        
        if (!GOOGLE_MAPS_API_KEY) {
            console.error('Google Maps API key not configured');
            return;
        }
        
        // Use Places API AutocompleteService (works for new customers)
        const pickupInput = document.getElementById('pickupAddress');
        const deliveryInput = document.getElementById('deliveryAddress');
        
        // Initialize using Places API AutocompleteService
        if (typeof google !== 'undefined' && google.maps && google.maps.places) {
            try {
                const autocompleteService = new google.maps.places.AutocompleteService();
                const placesService = new google.maps.places.PlacesService(document.createElement('div'));
                
                // Setup pickup autocomplete
                if (pickupInput) {
                    setupAutocompleteInput(pickupInput, autocompleteService, placesService, 'pickup', function(lat, lng, address) {
                        document.getElementById('pickupLat').value = lat;
                        document.getElementById('pickupLng').value = lng;
                        document.getElementById('pickupAddress').value = address;
                        showLocationMap('pickupMap', lat, lng, 'Pickup Location');
                        calculatePrice();
                    });
                }
                
                // Setup delivery autocomplete
                if (deliveryInput) {
                    setupAutocompleteInput(deliveryInput, autocompleteService, placesService, 'delivery', function(lat, lng, address) {
                        document.getElementById('deliveryLat').value = lat;
                        document.getElementById('deliveryLng').value = lng;
                        document.getElementById('deliveryAddress').value = address;
                        showLocationMap('deliveryMap', lat, lng, 'Delivery Location');
                        calculatePrice();
                    });
                }
                
                console.log('âœ… Autocomplete initialized successfully using Places API AutocompleteService!');
            } catch (error) {
                console.error('âŒ Error initializing autocomplete:', error);
                // Fallback to backend API
                console.log('Falling back to backend autocomplete API');
                setupBackendAutocomplete();
            }
        } else {
            console.warn('Google Maps Places API not available, using fallback');
            // Fallback: Use our backend API for autocomplete
            setupBackendAutocomplete();
        }
    }
    
    // Setup autocomplete using Google Places API
    function setupAutocompleteInput(input, autocompleteService, placesService, type, callback) {
        let timeout;
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'autocomplete-suggestions';
        suggestionsDiv.style.cssText = 'position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 2px;';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestionsDiv);
        
        input.addEventListener('input', function() {
            const query = input.value.trim();
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                autocompleteService.getPlacePredictions({
                    input: query,
                    componentRestrictions: { country: 'ke' },
                    types: ['address']
                }, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                        suggestionsDiv.innerHTML = '';
                        predictions.forEach(prediction => {
                            const item = document.createElement('div');
                            item.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;';
                            item.textContent = prediction.description;
                            item.addEventListener('mouseenter', () => item.style.backgroundColor = '#f0f0f0');
                            item.addEventListener('mouseleave', () => item.style.backgroundColor = 'white');
                            item.addEventListener('click', () => {
                                input.value = prediction.description;
                                suggestionsDiv.style.display = 'none';
                                
                                // Get place details
                                placesService.getDetails({
                                    placeId: prediction.place_id,
                                    fields: ['geometry', 'formatted_address']
                                }, (place, status) => {
                                    if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry) {
                                        // Round to 6 decimal places to match database constraint
                                        const lat = parseFloat(place.geometry.location.lat().toFixed(6));
                                        const lng = parseFloat(place.geometry.location.lng().toFixed(6));
                                        callback(lat, lng, place.formatted_address);
                                    }
                                });
                            });
                            suggestionsDiv.appendChild(item);
                        });
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }, 300);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }
    
    // Fallback: Use backend API for autocomplete
    function setupBackendAutocomplete() {
        const pickupInput = document.getElementById('pickupAddress');
        const deliveryInput = document.getElementById('deliveryAddress');
        
        if (pickupInput) {
            setupBackendAutocompleteInput(pickupInput, 'pickup');
        }
        if (deliveryInput) {
            setupBackendAutocompleteInput(deliveryInput, 'delivery');
        }
    }
    
    function setupBackendAutocompleteInput(input, type) {
        let timeout;
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'autocomplete-suggestions';
        suggestionsDiv.style.cssText = 'position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 2px;';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestionsDiv);
        
        input.addEventListener('input', function() {
            const query = input.value.trim();
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                fetch(`/api/maps/autocomplete/?query=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.predictions && data.predictions.length > 0) {
                            suggestionsDiv.innerHTML = '';
                            data.predictions.forEach(prediction => {
                                const item = document.createElement('div');
                                item.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;';
                                item.textContent = prediction.description;
                                item.addEventListener('mouseenter', () => item.style.backgroundColor = '#f0f0f0');
                                item.addEventListener('mouseleave', () => item.style.backgroundColor = 'white');
                                item.addEventListener('click', () => {
                                    input.value = prediction.description;
                                    suggestionsDiv.style.display = 'none';
                                    
                                    // Geocode the selected address
                                    fetch(`/api/maps/geocode/?address=${encodeURIComponent(prediction.description)}`)
                                        .then(res => res.json())
                                        .then(geoData => {
                                            if (geoData.results && geoData.results.length > 0) {
                                                const location = geoData.results[0].geometry.location;
                                                // Round to 6 decimal places to match database constraint
                                                const lat = parseFloat(parseFloat(location.lat).toFixed(6));
                                                const lng = parseFloat(parseFloat(location.lng).toFixed(6));
                                                
                                                if (type === 'pickup') {
                                                    document.getElementById('pickupLat').value = lat;
                                                    document.getElementById('pickupLng').value = lng;
                                                    showLocationMap('pickupMap', lat, lng, 'Pickup Location');
                                                } else {
                                                    document.getElementById('deliveryLat').value = lat;
                                                    document.getElementById('deliveryLng').value = lng;
                                                    showLocationMap('deliveryMap', lat, lng, 'Delivery Location');
                                                }
                                                calculatePrice();
                                            }
                                        });
                                });
                                suggestionsDiv.appendChild(item);
                            });
                            suggestionsDiv.style.display = 'block';
                        } else {
                            suggestionsDiv.style.display = 'none';
                        }
                    })
                    .catch(err => console.error('Autocomplete error:', err));
            }, 300);
        });
        
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }
    
    // Show location on map
    function showLocationMap(mapId, lat, lng, title) {
        const mapDiv = document.getElementById(mapId);
        if (!mapDiv || typeof google === 'undefined' || !google.maps) {
            console.warn('Google Maps not available for map display');
            return;
        }
        
        mapDiv.style.display = 'block';
        
        if (mapId === 'pickupMap') {
            if (!pickupMap) {
                pickupMap = new google.maps.Map(mapDiv, {
                    center: { lat: lat, lng: lng },
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: false
                });
            } else {
                pickupMap.setCenter({ lat: lat, lng: lng });
            }
            
            if (pickupMarker) {
                pickupMarker.setPosition({ lat: lat, lng: lng });
            } else {
                pickupMarker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: pickupMap,
                    title: title,
                    icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                });
            }
        } else {
            if (!deliveryMap) {
                deliveryMap = new google.maps.Map(mapDiv, {
                    center: { lat: lat, lng: lng },
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: false
                });
            } else {
                deliveryMap.setCenter({ lat: lat, lng: lng });
            }
            
            if (deliveryMarker) {
                deliveryMarker.setPosition({ lat: lat, lng: lng });
            } else {
                deliveryMarker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: deliveryMap,
                    title: title,
                    icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                });
            }
        }
    }
    
    function calculatePrice() {
        const pickupLat = parseFloat(document.getElementById('pickupLat').value);
        const pickupLng = parseFloat(document.getElementById('pickupLng').value);
        const deliveryLat = parseFloat(document.getElementById('deliveryLat').value);
        const deliveryLng = parseFloat(document.getElementById('deliveryLng').value);
        
        if (isNaN(pickupLat) || isNaN(pickupLng) || isNaN(deliveryLat) || isNaN(deliveryLng)) {
            document.getElementById('estimatedPrice').textContent = 'KES 0';
            return;
        }
        
        const nairobiBounds = {
            minLat: -1.5, maxLat: -1.1,
            minLng: 36.6, maxLng: 37.0
        };
        
        const pickupInNairobi = (
            pickupLat >= nairobiBounds.minLat && 
            pickupLat <= nairobiBounds.maxLat &&
            pickupLng >= nairobiBounds.minLng && 
            pickupLng <= nairobiBounds.maxLng
        );
        
        const deliveryInNairobi = (
            deliveryLat >= nairobiBounds.minLat && 
            deliveryLat <= nairobiBounds.maxLat &&
            deliveryLng >= nairobiBounds.minLng && 
            deliveryLng <= nairobiBounds.maxLng
        );
        
        const price = (pickupInNairobi && deliveryInNairobi) ? 150 : 300;
        document.getElementById('estimatedPrice').textContent = `KES ${price}`;
        console.log('Price calculated:', price, 'Pickup in Nairobi:', pickupInNairobi, 'Delivery in Nairobi:', deliveryInNairobi);
    }
    
    // Load orders
    async function loadOrders() {
        try {
            const response = await fetch(`${API_BASE}/orders/`, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Orders response:', data);
            
            // Handle paginated response
            let orders = data.results || data;
            if (!Array.isArray(orders)) {
                orders = [];
            }
            
            const ordersList = document.getElementById('ordersList');
            if (!orders || orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h4 style="color: #666; margin-bottom: 1rem;">No orders yet</h4>
                        <p>Create your first order to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Ensure orders is an array
            const ordersArray = Array.isArray(orders) ? orders : [];
            ordersList.innerHTML = ordersArray.map(order => {
                const statusClass = `status-${order.status}`;
                const statusText = order.status.replace(/_/g, ' ').toUpperCase();
                const createdDate = new Date(order.created_at).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let actionButton = '';
                if (order.status === 'pending_payment') {
                    actionButton = `<button class="action-btn action-btn-primary" onclick="initiatePayment(${order.id})">
                        <i class="fas fa-credit-card"></i> Pay Now
                    </button>`;
                } else {
                    actionButton = `<a href="/track/${order.tracking_code}/" class="action-btn action-btn-outline">
                        <i class="fas fa-eye"></i> Track
                    </a>`;
                }
                
                // M-Pesa Till Number display (Safaricom green) - always visible
                const mpesaTillNumber = '{{ MPESA_TILL_NUMBER|default:"K217328" }}';
                const mpesaInfo = `
                    <div class="mpesa-till-info" style="background: linear-gradient(135deg, #00A859 0%, #007A3D 100%); color: white; padding: 0.75rem; border-radius: 10px; margin-top: 0.5rem; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0, 168, 89, 0.3); border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-mobile-alt" style="font-size: 1.1rem;"></i> 
                                <span>M-Pesa Till:</span>
                            </span>
                            <span style="font-weight: 700; font-size: 1.2rem; letter-spacing: 2px; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 5px; font-family: 'Courier New', monospace;">${mpesaTillNumber}</span>
                        </div>
                        <small style="opacity: 0.95; display: block; font-size: 0.75rem;">
                            ${order.status === 'pending_payment' ? 'ðŸ’³ Pay via M-Pesa or click "Pay Now" button' : 'ðŸ“± Use this Till number for M-Pesa payments'}
                        </small>
                    </div>
                `;
                
                return `
                    <div class="order-card">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <a href="/track/${order.tracking_code}/" class="tracking-code">${order.tracking_code}</a>
                                <p class="text-muted mb-0" style="font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${createdDate}
                                </p>
                            </div>
                            <div class="col-md-2">
                                <div class="order-price">KES ${order.price}</div>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-1" style="font-weight: 600;">
                                    ${order.pickup_address ? (order.pickup_address.length > 30 ? order.pickup_address.substring(0, 30) + '...' : order.pickup_address) : 'N/A'}
                                </p>
                                <p class="text-muted mb-0" style="font-size: 0.9rem;">
                                    <i class="fas fa-arrow-right"></i> ${order.delivery_address ? (order.delivery_address.length > 30 ? order.delivery_address.substring(0, 30) + '...' : order.delivery_address) : 'N/A'}
                                </p>
                                ${mpesaInfo}
                            </div>
                            <div class="col-md-2">
                                <span class="status-badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="col-md-2 text-end">
                                ${actionButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('ordersList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4 style="color: #666; margin-bottom: 1rem;">Error Loading Orders</h4>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-3" onclick="loadOrders()">Retry</button>
                </div>
            `;
        }
    }
    
    // Create new order
    document.getElementById('newOrderForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Convert coordinates to numbers and round to 6 decimal places
        if (data.pickup_latitude) data.pickup_latitude = parseFloat(parseFloat(data.pickup_latitude).toFixed(6));
        if (data.pickup_longitude) data.pickup_longitude = parseFloat(parseFloat(data.pickup_longitude).toFixed(6));
        if (data.delivery_latitude) data.delivery_latitude = parseFloat(parseFloat(data.delivery_latitude).toFixed(6));
        if (data.delivery_longitude) data.delivery_longitude = parseFloat(parseFloat(data.delivery_longitude).toFixed(6));
        
        // Validate coordinates
        if (!data.pickup_latitude || !data.pickup_longitude) {
            alert('Please select a valid pickup address from the suggestions.');
            return;
        }
        
        if (!data.delivery_latitude || !data.delivery_longitude) {
            alert('Please select a valid delivery address from the suggestions.');
            return;
        }
        
        try {
            // Get CSRF token
            const csrftoken = getCookie('csrftoken');
            
            const response = await fetch(`${API_BASE}/orders/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (response.ok) {
                alert('Order created successfully!');
                bootstrap.Modal.getInstance(document.getElementById('newOrderModal')).hide();
                document.getElementById('newOrderForm').reset();
                document.getElementById('estimatedPrice').textContent = 'KES 0';
                // Clear autocomplete
                if (pickupAutocomplete) {
                    google.maps.event.clearInstanceListeners(document.getElementById('pickupAddress'));
                }
                if (deliveryAutocomplete) {
                    google.maps.event.clearInstanceListeners(document.getElementById('deliveryAddress'));
                }
                pickupAutocomplete = null;
                deliveryAutocomplete = null;
                loadOrders();
            } else {
                const errorMsg = result.error || result.detail || Object.values(result).flat().join(', ') || 'Failed to create order';
                alert(errorMsg);
            }
        } catch (error) {
            console.error('Error creating order:', error);
            alert('An error occurred. Please try again.');
        }
    });
    
    // Initiate payment
    async function initiatePayment(orderId) {
        const phone = prompt('Enter your M-Pesa phone number (e.g., 254712345678 or 0712345678):');
        if (!phone) return;
        
        // Normalize phone number (remove spaces, dashes, etc.)
        let normalizedPhone = phone.replace(/\s+/g, '').replace(/-/g, '').replace(/\+/g, '');
        
        // Ensure order_id is an integer
        const orderIdInt = parseInt(orderId);
        if (isNaN(orderIdInt)) {
            alert('Invalid order ID');
            return;
        }
        
        try {
            // Get CSRF token
            const csrftoken = getCookie('csrftoken');
            
            const requestData = {
                order_id: orderIdInt,
                phone_number: normalizedPhone
            };
            
            console.log('Sending payment request:', requestData);
            
            const response = await fetch(`${API_BASE}/payments/stkpush/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                credentials: 'include',
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            console.log('Payment response:', result);
            
            if (response.ok) {
                alert('Payment request sent! Please check your phone to complete payment.');
                loadOrders();
            } else {
                // Show detailed error messages
                let errorMsg = 'Payment failed';
                if (result.messages && result.messages.length > 0) {
                    errorMsg = result.messages.join('\n');
                } else if (result.error) {
                    errorMsg = result.error;
                } else if (result.detail) {
                    errorMsg = result.detail;
                } else if (result.details) {
                    errorMsg = JSON.stringify(result.details);
                }
                alert(errorMsg);
            }
        } catch (error) {
            console.error('Error initiating payment:', error);
            alert('An error occurred. Please try again. Check console for details.');
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadGoogleMaps();
        loadOrders();
        
        // Initialize autocomplete when modal opens
        const newOrderModal = document.getElementById('newOrderModal');
        if (newOrderModal) {
            // Use both 'show' and 'shown' events for better compatibility
            newOrderModal.addEventListener('show.bs.modal', function() {
                console.log('New order modal showing...');
            });
            
            newOrderModal.addEventListener('shown.bs.modal', function() {
                console.log('New order modal opened, initializing autocomplete...');
                // Wait for modal animation and input fields to be visible
                setTimeout(function() {
                    // Force initialization even if maps not loaded yet
                    if (mapsLoaded) {
                        initAutocomplete();
                    } else {
                        console.log('Maps not loaded yet, waiting...');
                        // Wait for maps to load
                        let attempts = 0;
                        const maxAttempts = 50; // 5 seconds max
                        const checkMaps = setInterval(function() {
                            attempts++;
                            if (mapsLoaded) {
                                clearInterval(checkMaps);
                                console.log('Maps loaded, initializing autocomplete...');
                                initAutocomplete();
                            } else if (attempts >= maxAttempts) {
                                clearInterval(checkMaps);
                                console.warn('Maps did not load in time, trying to initialize anyway...');
                                // Try to initialize anyway - might work if Maps loaded but flag not set
                                initAutocomplete();
                            }
                        }, 100);
                    }
                }, 300);
            });
        }
        
        // Delete Account Form Handler
        document.getElementById('deleteAccountForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pin = document.getElementById('deletePin').value;
            const confirmCheckbox = document.getElementById('confirmDelete');
            
            if (!confirmCheckbox.checked) {
                alert('Please confirm that you understand this action is permanent.');
                return;
            }
            
            if (pin.length !== 4) {
                alert('Please enter your 4-digit PIN.');
                return;
            }
            
            if (!confirm('Are you absolutely sure you want to delete your account? This cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/delete-account/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'include',
                    body: JSON.stringify({ pin: pin })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('Your account has been permanently deleted.');
                    window.location.href = '/';
                } else {
                    const errorMsg = result.error || result.detail || 'Failed to delete account. Please check your PIN and try again.';
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });
</script>
{% endblock %}
